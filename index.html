<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>F1 Snake â€” Leaderboard + Chat + Ranks + RR + 2x XP + Middle Obstacles</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<style>
  /* ... all your existing CSS unchanged ... */
  /* Additional glow for Radiant */
  .radiant-glow {
    position: absolute;
    width: 140px;
    height: 140px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255,204,51,0.9) 0%, rgba(255,204,51,0.1) 70%, transparent 100%);
    pointer-events: none;
    animation: radiantPulse 1.2s ease-out forwards;
    filter: blur(6px);
    z-index: 9999;
  }
  @keyframes radiantPulse {
    0% { transform: scale(0.5); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.9; }
    100% { transform: scale(1.8); opacity: 0; }
  }
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
<!-- ... all your HTML unchanged up to the script ... -->
<script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
<script>
(() => {
  /* ========= Firebase ========= */
  const firebaseConfig = {
    apiKey: "AIzaSyC5seSlgxk4mCRn4HKet4rHlzhQVVBxc-8",
    authDomain: "f1-snake.firebaseapp.com",
    projectId: "f1-snake",
    storageBucket: "f1-snake.firebasestorage.app",
    messagingSenderId: "575341092161",
    appId: "1:575341092161:web:b9050e1df88c9e36de95c0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* ========= Ranks ========= */
  const RANKS = [
    'Iron 1','Iron 2','Iron 3',
    'Bronze 1','Bronze 2','Bronze 3',
    'Silver 1','Silver 2','Silver 3',
    'Gold 1','Gold 2','Gold 3',
    'Platinum 1','Platinum 2','Platinum 3',
    'Diamond 1','Diamond 2','Diamond 3',
    'Ascendant 1','Ascendant 2','Ascendant 3',
    'Immortal 1','Immortal 2','Immortal 3',
    'Radiant'
  ];
  const RADIANT_INDEX = RANKS.length - 1;
  function rankGroup(idx){
    if (idx === RADIANT_INDEX) return 'Radiant';
    const groups = ['Iron','Bronze','Silver','Gold','Platinum','Diamond','Ascendant','Immortal'];
    return groups[Math.floor(idx/3)] || 'Radiant';
  }
  function sanitizeId(name){
    return (name||'player').trim().toLowerCase().replace(/[^a-z0-9_-]/g,'_');
  }
  function rankColor(idx){
    const g = rankGroup(idx);
    switch(g){
      case 'Iron': return '#8c8c8c';
      case 'Bronze': return '#b88650';
      case 'Silver': return '#b9c3cf';
      case 'Gold': return '#e7c14c';
      case 'Platinum': return '#3dd4c6';
      case 'Diamond': return '#a24bff'; // purple
      case 'Ascendant': return '#4bd37d';
      case 'Immortal': return '#ff4b4b'; // red
      case 'Radiant': return '#ffcc33'; // richer gold
      default: return '#999';
    }
  }
  let currentRankColor = rankColor(0);
  function rankBadgeDataURI(idx, big=false){
    const col = rankColor(idx);
    const size = big ? 120 : 18;
    const tier = (idx === RADIANT_INDEX) ? 1 : (idx % 3) + 1;

    let shapeSVG;
    if (tier === 1) {
      shapeSVG = `<polygon points="9,1 16,6 13.8,16 4.2,16 2,6" fill="url(#g)" stroke="${col}" stroke-width="1" filter="url(#s)"/>`;
    } else if (tier === 2) {
      shapeSVG = `<circle cx="9" cy="9" r="8" fill="url(#g)" stroke="${col}" stroke-width="1" filter="url(#s)"/>`;
    } else {
      shapeSVG = `<polygon points="9,1 10.8,6 16,6 12,9.5 13.5,15 9,12 4.5,15 6,9.5 2,6 7.2,6" fill="url(#g)" stroke="${col}" stroke-width="1" filter="url(#s)"/>`;
    }

    // Extra glow for Radiant
    const glowFilter = (idx === RADIANT_INDEX) ? `
      <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
        <feMerge>
          <feMergeNode in="coloredBlur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>` : '';

    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 18 18">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="${col}"/>
            <stop offset="1" stop-color="#111"/>
          </linearGradient>
          <filter id="s" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="0" stdDeviation="0.8" flood-color="${col}" flood-opacity="0.6"/>
          </filter>
          ${glowFilter}
        </defs>
        ${shapeSVG}
      </svg>`;

    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  /* ==== Rank-up animation override ==== */
  function spawnBursts(centerX, centerY, count=30, colorOverride=null){
    for(let i=0;i<count;i++){
      const b = document.createElement('div');
      b.className = 'burst';
      const angle = Math.random()*Math.PI*2;
      const dist = 120 + Math.random()*120;
      const dx = Math.cos(angle)*dist, dy = Math.sin(angle)*dist;
      b.style.left = `${centerX}px`; b.style.top = `${centerY}px`;
      b.style.setProperty('--dx', dx+'px');
      b.style.setProperty('--dy', dy+'px');
      const hueColor = colorOverride || `hsl(${Math.floor(Math.random()*360)}, 85%, 65%)`;
      b.style.background = hueColor;
      document.body.appendChild(b);
      setTimeout(()=>b.remove(), 900);
    }
  }
  function showRankUpAnimation(newIdx, promos){
    const rect = rankNowIcon.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;

    if (newIdx === RADIANT_INDEX) {
      spawnBursts(cx, cy, 60, '#ffcc33'); // more bursts in gold
      const glow = document.createElement('div');
      glow.className = 'radiant-glow';
      glow.style.left = `${cx - 70}px`;
      glow.style.top = `${cy - 70}px`;
      document.body.appendChild(glow);
      setTimeout(()=>glow.remove(), 1500);
    } else {
      spawnBursts(cx, cy, 36 + promos*12);
    }

    rankUpBadge.src = rankBadgeDataURI(newIdx, true);
    rankUpText.textContent = promos >= 2 ? 'DOUBLE PROMOTION!' : 'RANK UP!';
    rankUpOverlay.style.display = 'grid';
    setTimeout(()=>{ rankUpOverlay.style.display='none'; }, 1400);
  }

  /* ==== Rest of your existing JS remains unchanged ==== */
  // ... paste the rest of your original JS here without changes ...
})();
</script>
</body>
</html>
